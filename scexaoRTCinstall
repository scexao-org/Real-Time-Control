#!/bin/bash

RTCDIR="${HOME}/Real-Time-Control"



# ==============================================================
# Deploy RTC scripts
# ==============================================================

cd ${HOME}
mkdir -p scexaoRTCbin
# populate scexaoRTCbin
cp ${RTCDIR}/scexaoRTCbin/* ${HOME}/scexaoRTCbin/

cd ${HOME}
mkdir -p scexaoRTCconf
# populate scexaoRTCconf
cp ${RTCDIR}/scexaoRTCconf/* ${HOME}/scexaoRTCconf/
cd ${HOME}/scexaoRTCconf
./confinstall
source ~/.profile

mkdir -p scexaoRTCsoft






# COMPILE EXECUTABLES
cd ${HOME}/scexaoRTCbin

# compile and install setlatency executable
gcc -o setlatency ${RTCDIR}/scexaoRTCprogs/setlatency/setlatency.c







# ==============================================================
# NETWORK
# ==============================================================

sudo cp ${HOME}/scexaoRTCconf/50-cloud-init.yaml /etc/netplan/50-cloud-init.yaml
sudo netplan apply

# to check hardware interfaces:
# sudo lshw -class network -businfo

# Bus info          Device     Class          Description
# =======================================================
# pci@0000:01:00.0  enp1s0f0   network        Ethernet Controller 10G X550T
# pci@0000:01:00.1  enp1s0f1   network        Ethernet Controller 10G X550T
# pci@0000:1b:00.0  enp27s0f0  network        82599ES 10-Gigabit SFI/SFP+ Network Connection
# pci@0000:1b:00.1  enp27s0f1  network        82599ES 10-Gigabit SFI/SFP+ Network Connection
# pci@0000:86:00.0  ens4f0     network        MT27700 Family [ConnectX-4]
# pci@0000:86:00.1  ens4f1     network        MT27700 Family [ConnectX-4]
# pci@0000:db:00.0             network        MT27800 Family [ConnectX-5]
# pci@0000:db:00.1             network        MT27800 Family [ConnectX-5]






# ==============================================================
# STORAGE DRIVES
# ==============================================================

# create directories
cd /mnt

sudo mkdir sdata00
sudo chown scexao sdata00/
sudo chgrp scexao sdata00/

sudo mkdir md0
sudo chown scexao md0/
sudo chgrp scexao md0/

cd ${HOME}/scexaoRTCconf/
cat /etc/fstab fstabadd > fstab.new
cp /etc/fstab fstab.old
sudo cp fstab.new /etc/fstab

sudo mount /mnt/md0
sudo mount /mnt/sdata00




# ==============================================================
# REMOTE ACCESS, misc tools
# ==============================================================

# x2go
sudo apt install -y x2goserver
sudo apt install -y --no-install-recommends lxde
sudo apt install -y terminator

# To increase number of desktops etc...
sudo apt install -y wmctrl


# Misc convenience and tools
sudo apt install -y geany
sudo apt install -y gparted
sudo apt install -y iotop
sudo apt install -y numactl

sudo apt install -y saods9 






# ==============================================================
# DM driver
# ==============================================================

cd $HOME
mkdir -p src/DMoptical
cd src/DMoptical
rsync -au --progress /home/scexao/Real-Time-Control/scexaoRTCprogs/DMoptical/* .

# content was uncompressed by:
# tar -jxvf bmc_linux_sdk_2.2.tbz2
# Note: List of changes made to source code:

# In drv/bmc_mdrv.c
#- #include <asm/uaccess.h>
#+ #include <linux/uaccess.h>

#In drv/bmc_mdrv.c
#- #include <sys/ioctl.h>
#+ #include <linux/ioctl.h>

#In drv/bmc_mdrv.c
#+ #include <linux/uaccess.h>

#In lib/bmc_mdlib.c
#- #include <linux/ioctl.h>
#+ #include <sys/ioctl.h>

#In tool/bmc_ltest.c
+ #include <sys/time.h>

#Compile and install:

mkdir -p tmp
mkdir -p lib
cd src
make
cd ../bin
sudo insmod bmc_mdrv.ko
sudo chmod o+rw /dev/bmc_mdrv*







# ==============================================================
# CACAO 
# ==============================================================

cd ${HOME}
sudo apt-get install -y cmake flex bison pkg-config
sudo apt-get install -y libcfitsio-dev libreadline-dev libfftw3-dev libgsl-dev libncurses5-dev 

mkdir -p src
cd src
git clone --recursive https://github.com/cacao-org/cacao cacao
cd cacao
git submodule foreach "(git checkout dev; git pull)"
git checkout dev; git pull
mkdir _build
cd _build
cmake .. -DUSE_CUDA=ON -DUSE_MAGMA=ON
sudo make install
sudo ln -s /usr/local/bin/cacao /usr/local/bin/milk

# post installation

echo "/usr/local/lib" > usrlocal.conf
sudo mv usrlocal.conf /etc/ld.so.conf.d/
sudo ldconfig -v

cd ${HOME}
cd src/cacao
mkdir -p bin
cd bin
find /home/scexao/src/cacao/ -executable -type f -name "milk-*" -print0 | xargs -0 -I {} ln -s {} .
find /home/scexao/src/cacao/ -executable -type f -name "cacao-*" -print0 | xargs -0 -I {} ln -s {} .

echo "tmpfs /milk/shm tmpfs rw,nosuid,nodev" | sudo tee -a /etc/fstab
sudo mkdir -p /milk/shm
sudo mount /milk/shm




# ==============================================================
# CONFIGURE CACAO 
# ==============================================================

